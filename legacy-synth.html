<!DOCTYPE html>
<html>
    <head>
        <title>javaScript synth</title>
        <script src="synth.js"></script>

        <script>

        function normalize_invalid_values(samples)
        {
            for (var i = 0, len = samples.length; i < len; i++)
            {
                if (samples[i] > 1)
                    samples[i] = 1;
                else if (samples[i] < -1)
                    samples[i] = -1;
            }
        }

        function convert255(data)
        {
            var data_0_255 = [];

            for (var i = 0; i < data.length; i++)
                data_0_255[i] = 128 + Math.round(127 * data[i]);

            return data_0_255;
        }

        function note(o, n)
        {
            //            C      C#     D      Eb     E      F      F#     G      G#     A      Bb     B
            var notes0 = [16.35, 17.32,	18.35, 19.45, 20.60, 21.83,	23.12, 24.50, 25.96, 27.50, 29.14, 30.87];
            var notes1 = [32.70, 34.65,	36.71, 38.89, 41.20, 43.65,	46.25, 49.00, 51.91, 55.00, 58.27, 61.74];
            var notes2 = [65.41, 69.30,	73.42, 77.78, 82.41, 87.31,	92.50, 98.00, 103.8, 110.0, 116.5, 123.5];
            var notes3 = [130.8, 138.6,	146.8, 155.6, 164.8, 174.6,	185.0, 196.0, 207.7, 220.0, 233.1, 246.9];
            var notes4 = [261.6, 277.2,	293.7, 311.1, 329.6, 349.2,	370.0, 392.0, 415.3, 440.0, 466.2, 493.9];
            var notes5 = [523.3, 554.4, 587.3, 622.3, 659.3, 698.5, 740.0, 784.0, 830.6, 880.0, 932.3, 987.8];
            var notes6 = [1047 , 1109 , 1175 , 1245 , 1319 , 1397 , 1480 , 1568 , 1661 , 1760 , 1865 , 1976 ];
            var notes7 = [2093 , 2217 , 2349 , 2489 , 2637 , 2794 , 2960 , 3136 , 3322 , 3520 , 3729 , 3951 ];
            var notes8 = [4186 , 4435 , 4699 , 4978 , 5274 , 5588 , 5920 , 6272 , 6645 , 7040 , 7459 , 7902 ];

            if      (o == 0) return notes0[n];
            else if (o == 1) return notes1[n];
            else if (o == 2) return notes2[n];
            else if (o == 3) return notes3[n];
            else if (o == 4) return notes4[n];
            else if (o == 5) return notes5[n];
            else if (o == 6) return notes6[n];
            else if (o == 7) return notes7[n];
            else             return notes8[n];
        }

        function playSynth()
        {
            var sampleRate = 44100;
            var A_total = 0;
            var samples = new Array();

            var samples_length = 1 * sampleRate;

            var f = note(5, 0);

            /*for (var i = 0; i < 44100; i++)
            {
                var t = i / 44100;
                samples[i] = Math.pow(Math.sin(1.26 * f / 2 * 2 * Math.PI * t), 15);
            }*/

            //bass
            /*for (var i = 0; i < 44100; i++)
            {
                var t = i / 44100;
                samples[i] = Math.pow(Math.sin(1.26 * f / 2 * 2 * Math.PI * t), 15) * Math.pow((1 - t), 3) * Math.pow(Math.sin(1.26 * f / 10 * 2 * Math.PI * t), 3) * 10;
            }*/

            //violin
            for (var i = 0; i < samples_length; i++)
            {
                var t = i / samples_length;
                var y = 0;
                var A_total = 0;

                for (var harm = 1; harm <= 7; harm++)
                {
                    var f2 = f * harm;
                    var A = 1 / harm;
                    A_total += A;
                    y += A * Math.sin(f2 * 2 * Math.PI * t);
                }

                samples[i] = y / A_total;
                samples[i] *= (1 - 0.5 * Math.sin(2 * Math.PI * 6 * t)); // Add a low frequency amplitude modulation
                samples[i] *= (1 - Math.exp(-t * 3));

                if (i < 1000)
                console.log(samples[i]);
            }

            normalize_invalid_values(samples); // keep samples between [-1, +1]

            var wave = new RIFFWAVE();
            wave.header.sampleRate = sampleRate;
            wave.header.numChannels = 1;

            var audio = new Audio();
            var samples2 = convert255(samples);
            wave.Make(samples2);
            audio.src = wave.dataURI;
            setTimeout(function() { audio.play(); }, 10); // page needs time to load?
        }

        </script>
    </head>

    <body>
        <p>synth</p>
        <button type="button" onclick="playSynth()">play</button>
    </body>
</html>
